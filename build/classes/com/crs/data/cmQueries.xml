<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="CarpoolMember">
	<resultMap id="resultCarpoolMember" type="com.crs.model.CarPoolMemberForm">
	    <result property="employeeID" column="employee_id"/>
	    <result property="carpoolID" column="carpool_id"/>
	    <result property="dateJoined" column="date_joined"/>
	    <result property="isDriver" column="is_driver"/>
	    <result property="isPickUp" column="pick_up"/>
	    <result property="isTemporary" column="is_temporary"/>
	 	<collection property="employeeList" column="employee_id" javaType="ArrayList"
	 	ofType="com.crs.model.EmployeeForm" resultMap="resultEmployee"/>
     </resultMap>
    
    <resultMap id="result" type="com.crs.model.CarPoolMemberForm">
	    <result property="employeeID" column="employee_id"/>
	    <result property="carpoolID" column="carpool_id"/>
	    <result property="dateJoined" column="date_joined"/>
	    <result property="isDriver" column="is_driver"/>
	    <result property="isPickUp" column="pick_up"/>
	    <result property="isTemporary" column="is_temporary"/>
	 </resultMap>
    
    
    
    <resultMap id="resultEmployee" type="com.crs.model.EmployeeForm">
	    <result property="employeeID" column="employee_id"/>
	    <result property="emailID" column="email"/>
	    <result property="password" column="password"/>
	    <result property="salt" column="salt"/>
	    <result property="firstName" column="first_name"/>
	    <result property="lastName" column="last_name"/>
	    <result property="securityQn" column="sec_question"/>
	    <result property="securityAns" column="sec_answer"/>
	    <result property="phoneNo" column="phone"/>
	    <result property="notifyType" column="notify_type"/>
	    <result property="address" column="address"/>
	    <result property="dateJoined" column="date_joined"/>
	    <result property="points" column="points"/>
    </resultMap>
   
    <insert id="insertRecord" parameterType="CarpoolMember">
    	INSERT INTO CarpoolMember (employee_id,carpool_id,is_driver,is_temporary) VALUES (#{employeeID},#{carpoolID},#{isDriver},#{isTemporary})
    </insert>
    
    <select id="carpoolMembers" parameterType="int" resultMap="resultCarpoolMember">
    	SELECT * FROM CarpoolMember WHERE carpool_id = #{carpoolID} ORDER BY employee_id ASC
    </select>
    
     <select id="getCarpoolMembers" parameterType="CarpoolMember" resultMap="resultCarpoolMember" >
    	SELECT first_name, last_name, phone, email, is_driver, address, carpool_id
		FROM CarpoolMember 
		JOIN Employee 
		ON CarpoolMember.employee_id = employee.employee_id
		WHERE carpool_id = #{carpoolID}
		GROUP BY carpool_id,CarpoolMember.employee_id;
    </select>
    
    <select id="getMemberDetails" parameterType="int" resultMap="result">
    	SELECT * FROM CarpoolMember WHERE employee_id = #{employeeID}
    </select>
    
    <select id="getCarpoolMemberDrivers" parameterType="int" resultMap="resultCarpoolMember">
    	SELECT *
		FROM CarpoolMember
		WHERE is_driver = 1
		GROUP BY carpool_id;
    </select>
    
    <select id="getNextDriver" parameterType="int" resultMap="result">
    	SELECT * FROM CarpoolMember WHERE date_joined > (SELECT date_joined FROM CarpoolMember WHERE employee_id = #{currentDriver}) LIMIT 1
    </select>
    
    <select id="getFirstDriver" resultMap="result">
    	SELECT * FROM CarpoolMember ORDER BY date_joined ASC LIMIT 1 
    </select>
    
    <update id="updateCurrentDriver" parameterType="int">
    	UPDATE CarpoolMember SET is_driver = 0 WHERE employee_id = #{currentDriver}
    </update>
    
    <update id="updateNextDriver" parameterType="int">
    	UPDATE CarpoolMember SET is_driver = 1 WHERE employee_id = #{nextDriver}
    </update>
    
    <select id="getCarpoolMemberPassengers" parameterType="CarpoolMember" resultMap="resultCarpoolMember" >
    	SELECT first_name, last_name, phone, email, is_driver
		FROM CarpoolMember 
		JOIN Employee 
		ON CarpoolMember.employee_id = employee.employee_id
		WHERE carpool_id = #{carpoolID} AND CarpoolMember.is_driver &lt; 1
		GROUP BY carpool_id,CarpoolMember.employee_id;
    </select>
    
    
    <update id="cancelPickup" parameterType="CarpoolMember">
    	UPDATE CarpoolMember SET pick_up = 0 WHERE employee_id = #{employeeID}
    </update>
    
    <update id="cancelDrive" parameterType="CarpoolMember">
    	UPDATE CarpoolMember SET is_driver = 1 and is_temporary = 1 WHERE (SELECT * from Carpoolmember where date_joined > #{dateJoined} limit 1)
    	UPDATE Employee SET points = points - 5 WHERE employee_id = #{employeeID}
    </update>
    
    <delete id="removeMember" parameterType="CarpoolMember">
    	DELETE FROM CarpoolMember WHERE employee_id = #{employeeID}
    </delete>
    
    <delete id="removeTemporaryMembers" parameterType="CarpoolMember">
    	DELETE FROM CarpoolMember WHERE is_temporary = 1
    </delete>
</mapper>